# cloudbuild.yaml - place this file in the root of your 'my-trading-platform' directory
steps:
# Step 1: Build the Docker image for your application.
# This uses the Dockerfile in your project's root directory.
- name: 'gcr.io/cloud-builders/docker'
  id: 'Build'
  args: [
    'build',
    '-t',
    # The image will be tagged with the format: LOCATION-docker.pkg.dev/PROJECT_ID/REPOSITORY/IMAGE_NAME:COMMIT_SHA
    # Cloud Build automatically substitutes $PROJECT_ID and $COMMIT_SHA.
    # TODO: Replace 'us-central1' and 'my-trading-repo' with your Artifact Registry details if they are different.
    'us-central1-docker.pkg.dev/$PROJECT_ID/my-trading-repo/my-trading-platform-image:$COMMIT_SHA',
    '.'
  ]

# Step 2: Push the Docker image to Google Artifact Registry.
# This makes the image available for deployment.
- name: 'gcr.io/cloud-builders/docker'
  id: 'Push'
  args: [
    'push',
    # The image path must exactly match the one from the 'Build' step.
    'us-central1-docker.pkg.dev/$PROJECT_ID/my-trading-repo/my-trading-platform-image:$COMMIT_SHA'
  ]

# Step 3: Deploy the container to a private Cloud Run service.
- name: 'gcr.io/google-cloud-builders/gcloud'
  id: 'Deploy to Cloud Run'
  args: [
    'run',
    'deploy',
    'my-trading-platform-service', # This will be the name of your Cloud Run service.
    '--image', 'us-central1-docker.pkg.dev/$PROJECT_ID/my-trading-repo/my-trading-platform-image:$COMMIT_SHA',
    '--region', 'us-central1', # IMPORTANT: Set this to your preferred Google Cloud region.
    '--platform', 'managed',
    '--no-allow-unauthenticated', # Make the service private, invokable only by authenticated requests.
    '--memory', '1Gi', # Allocate sufficient memory for data processing.
    # Mount secrets from Google Secret Manager as environment variables.
    # The format is 'ENV_VAR_NAME=SECRET_NAME:VERSION'.
    # You must create these secrets in Secret Manager first.
    '--set-secrets=KITE_API_KEY=KITE_API_KEY:latest',
    '--set-secrets=KITE_ACCESS_TOKEN=KITE_ACCESS_TOKEN:latest',
    '--set-secrets=GOOGLE_SHEETS_CREDENTIALS=GOOGLE_SHEETS_CREDENTIALS:latest',
    '--set-secrets=TELEGRAM_BOT_TOKEN=TELEGRAM_BOT_TOKEN:latest',
    '--set-secrets=TELEGRAM_CHAT_ID=TELEGRAM_CHAT_ID:latest'
  ]

# This section lists the images that were built and pushed.
images:
- 'us-central1-docker.pkg.dev/$PROJECT_ID/my-trading-repo/my-trading-platform-image:$COMMIT_SHA'